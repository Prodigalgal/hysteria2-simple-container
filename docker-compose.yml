# hy2/docker-compose.yml
services:
  traefik:
    image: traefik:v2.10
    container_name: traefik
    restart: unless-stopped
    ports:
      - "80:80/tcp"
      - "443:443/tcp"
      - "443:443/udp"
    volumes:
      - ./letsencrypt:/letsencrypt
      - /var/run/docker.sock:/var/run/docker.sock:ro
    environment:
      - "LE_EMAIL=${LE_EMAIL}"
    command:
      - --providers.docker=true
      - --providers.docker.exposedbydefault=false
      - --entrypoints.web.address=:80/tcp
      - --entrypoints.websecure.address=:443/tcp
      - --entrypoints.quic.address=:443/udp
      - --certificatesresolvers.le.acme.email=${LE_EMAIL}
      - --certificatesresolvers.le.acme.storage=/letsencrypt/acme.json
      - --certificatesresolvers.le.acme.httpchallenge.entrypoint=web

  hysteria-server:
    build:
      context: .
    container_name: hysteria-server
    restart: unless-stopped
    environment:
      - "DOMAIN=${DOMAIN}"
      - "PASSWORD=${PASSWORD}"
      - "HYSTERIA_VERSION=${HYSTERIA_VERSION:-2.6.0}"
    labels:
      - "traefik.enable=true"
      # TCP Router: 它的作用是处理伪装流量，以及最重要的——为 ${DOMAIN} 申请和管理证书。
      - "traefik.tcp.routers.hysteria-tcp.entrypoints=websecure"
      - "traefik.tcp.routers.hysteria-tcp.rule=HostSNI(`${DOMAIN}`)"
      - "traefik.tcp.routers.hysteria-tcp.tls=true"
      - "traefik.tcp.routers.hysteria-tcp.tls.certresolver=le"
      - "traefik.tcp.services.hysteria-tcp.loadbalancer.server.port=443"

      # ---【关键修正】---
      # UDP Router: 它只负责将 QUIC 入口点的所有流量，无条件转发到 Hysteria 服务。
      # 无需，且不能有 'rule' 或 'tls' 标签。
      - "traefik.udp.routers.hysteria-udp.entrypoints=quic"
      - "traefik.udp.services.hysteria-udp.loadbalancer.server.port=443"
      # ---【修正结束】---
    volumes:
      - ./entrypoint.sh:/usr/local/bin/entrypoint.sh:ro
      - ./letsencrypt:/etc/hysteria/certs:ro
